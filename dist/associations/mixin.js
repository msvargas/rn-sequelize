'use strict';

const _ = require('lodash');

const HasOne = require('./has-one');

const HasMany = require('./has-many');

const BelongsToMany = require('./belongs-to-many');

const BelongsTo = require('./belongs-to');

function isModel(model, sequelize) {
  return model && model.prototype && model.prototype instanceof sequelize.Sequelize.Model;
}

const Mixin = {
  hasMany(target, options = {}) {
    if (!isModel(target, this.sequelize)) {
      throw new Error(`${this.name}.hasMany called with something that's not a subclass of Sequelize.Model`);
    }

    const source = this; // Since this is a mixin, we'll need a unique letiable name for hooks (since Model will override our hooks option)

    options.hooks = options.hooks === undefined ? false : Boolean(options.hooks);
    options.useHooks = options.hooks;
    options = Object.assign(options, _.omit(source.options, ['hooks']));

    if (options.useHooks) {
      this.runHooks('beforeAssociate', {
        source,
        target,
        type: HasMany
      }, options);
    } // the id is in the foreign table or in a connecting table


    const association = new HasMany(source, target, options);
    source.associations[association.associationAccessor] = association;

    association._injectAttributes();

    association.mixin(source.prototype);

    if (options.useHooks) {
      this.runHooks('afterAssociate', {
        source,
        target,
        type: HasMany,
        association
      }, options);
    }

    return association;
  },

  belongsToMany(target, options = {}) {
    if (!isModel(target, this.sequelize)) {
      throw new Error(`${this.name}.belongsToMany called with something that's not a subclass of Sequelize.Model`);
    }

    const source = this; // Since this is a mixin, we'll need a unique letiable name for hooks (since Model will override our hooks option)

    options.hooks = options.hooks === undefined ? false : Boolean(options.hooks);
    options.useHooks = options.hooks;
    options.timestamps = options.timestamps === undefined ? this.sequelize.options.timestamps : options.timestamps;
    options = Object.assign(options, _.omit(source.options, ['hooks', 'timestamps', 'scopes', 'defaultScope']));

    if (options.useHooks) {
      this.runHooks('beforeAssociate', {
        source,
        target,
        type: BelongsToMany
      }, options);
    } // the id is in the foreign table or in a connecting table


    const association = new BelongsToMany(source, target, options);
    source.associations[association.associationAccessor] = association;

    association._injectAttributes();

    association.mixin(source.prototype);

    if (options.useHooks) {
      this.runHooks('afterAssociate', {
        source,
        target,
        type: BelongsToMany,
        association
      }, options);
    }

    return association;
  },

  getAssociations(target) {
    return _.values(this.associations).filter(association => association.target.name === target.name);
  },

  getAssociationForAlias(target, alias) {
    // Two associations cannot have the same alias, so we can use find instead of filter
    return this.getAssociations(target).find(association => association.verifyAssociationAlias(alias)) || null;
  }

}; // The logic for hasOne and belongsTo is exactly the same

function singleLinked(Type) {
  return function (target, options = {}) {
    // eslint-disable-next-line no-invalid-this
    const source = this;

    if (!isModel(target, source.sequelize)) {
      throw new Error(`${source.name}.${_.lowerFirst(Type.name)} called with something that's not a subclass of Sequelize.Model`);
    } // Since this is a mixin, we'll need a unique letiable name for hooks (since Model will override our hooks option)


    options.hooks = options.hooks === undefined ? false : Boolean(options.hooks);
    options.useHooks = options.hooks;

    if (options.useHooks) {
      source.runHooks('beforeAssociate', {
        source,
        target,
        type: Type
      }, options);
    } // the id is in the foreign table


    const association = new Type(source, target, Object.assign(options, source.options));
    source.associations[association.associationAccessor] = association;

    association._injectAttributes();

    association.mixin(source.prototype);

    if (options.useHooks) {
      source.runHooks('afterAssociate', {
        source,
        target,
        type: Type,
        association
      }, options);
    }

    return association;
  };
}

Mixin.hasOne = singleLinked(HasOne);
Mixin.belongsTo = singleLinked(BelongsTo);
module.exports = Mixin;
module.exports.Mixin = Mixin;
module.exports.default = Mixin;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL2xpYi9hc3NvY2lhdGlvbnMvbWl4aW4uanMiXSwibmFtZXMiOlsiXyIsInJlcXVpcmUiLCJIYXNPbmUiLCJIYXNNYW55IiwiQmVsb25nc1RvTWFueSIsIkJlbG9uZ3NUbyIsImlzTW9kZWwiLCJtb2RlbCIsInNlcXVlbGl6ZSIsInByb3RvdHlwZSIsIlNlcXVlbGl6ZSIsIk1vZGVsIiwiTWl4aW4iLCJoYXNNYW55IiwidGFyZ2V0Iiwib3B0aW9ucyIsIkVycm9yIiwibmFtZSIsInNvdXJjZSIsImhvb2tzIiwidW5kZWZpbmVkIiwiQm9vbGVhbiIsInVzZUhvb2tzIiwiT2JqZWN0IiwiYXNzaWduIiwib21pdCIsInJ1bkhvb2tzIiwidHlwZSIsImFzc29jaWF0aW9uIiwiYXNzb2NpYXRpb25zIiwiYXNzb2NpYXRpb25BY2Nlc3NvciIsIl9pbmplY3RBdHRyaWJ1dGVzIiwibWl4aW4iLCJiZWxvbmdzVG9NYW55IiwidGltZXN0YW1wcyIsImdldEFzc29jaWF0aW9ucyIsInZhbHVlcyIsImZpbHRlciIsImdldEFzc29jaWF0aW9uRm9yQWxpYXMiLCJhbGlhcyIsImZpbmQiLCJ2ZXJpZnlBc3NvY2lhdGlvbkFsaWFzIiwic2luZ2xlTGlua2VkIiwiVHlwZSIsImxvd2VyRmlyc3QiLCJoYXNPbmUiLCJiZWxvbmdzVG8iLCJtb2R1bGUiLCJleHBvcnRzIiwiZGVmYXVsdCJdLCJtYXBwaW5ncyI6IkFBQUE7O0FBRUEsTUFBTUEsQ0FBQyxHQUFHQyxPQUFPLENBQUMsUUFBRCxDQUFqQjs7QUFDQSxNQUFNQyxNQUFNLEdBQUdELE9BQU8sQ0FBQyxXQUFELENBQXRCOztBQUNBLE1BQU1FLE9BQU8sR0FBR0YsT0FBTyxDQUFDLFlBQUQsQ0FBdkI7O0FBQ0EsTUFBTUcsYUFBYSxHQUFHSCxPQUFPLENBQUMsbUJBQUQsQ0FBN0I7O0FBQ0EsTUFBTUksU0FBUyxHQUFHSixPQUFPLENBQUMsY0FBRCxDQUF6Qjs7QUFFQSxTQUFTSyxPQUFULENBQWlCQyxLQUFqQixF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O0FBQ0EsVUFBTWEsV0FBVyxHQUFHLElBQUllLElBQUosQ0FBU3pCLE1BQVQsRUFBaUJKLE1BQWpCLEVBQXlCUyxNQUFNLENBQUNDLE1BQVAsQ0FBY1QsT0FBZCxFQUF1QkcsTUFBTSxDQUFDSCxPQUE5QixDQUF6QixDQUFwQjtBQUNBRyxJQUFBQSxNQUFNLENBQUNXLFlBQVAsQ0FBb0JELFdBQVcsQ0FBQ0UsbUJBQWhDLElBQXVERixXQUF2RDs7QUFFQUEsSUFBQUEsV0FBVyxDQUFDRyxpQkFBWjs7QUFDQUgsSUFBQUEsV0FBVyxDQUFDSSxLQUFaLENBQWtCZCxNQUFNLENBQUNULFNBQXpCOztBQUVBLFFBQUlNLE9BQU8sQ0FBQ08sUUFBWixFQUFzQjtBQUNwQkosTUFBQUEsTUFBTSxDQUFDUSxRQUFQLENBQWdCLGdCQUFoQixFQUFrQztBQUFFUixRQUFBQSxNQUFGO0FBQVVKLFFBQUFBLE1BQVY7QUFBa0JhLFFBQUFBLElBQUksRUFBRWdCLElBQXhCO0FBQThCZixRQUFBQTtBQUE5QixPQUFsQyxFQUErRWIsT0FBL0U7QUFDRDs7QUFFRCxXQUFPYSxXQUFQO0FBQ0QsR0EzQkQ7QUE0QkQ7O0FBRURoQixLQUFLLENBQUNpQyxNQUFOLEdBQWVILFlBQVksQ0FBQ3hDLE1BQUQsQ0FBM0I7QUFDQVUsS0FBSyxDQUFDa0MsU0FBTixHQUFrQkosWUFBWSxDQUFDckMsU0FBRCxDQUE5QjtBQUVBMEMsTUFBTSxDQUFDQyxPQUFQLEdBQWlCcEMsS0FBakI7QUFDQW1DLE1BQU0sQ0FBQ0MsT0FBUCxDQUFlcEMsS0FBZixHQUF1QkEsS0FBdkI7QUFDQW1DLE1BQU0sQ0FBQ0MsT0FBUCxDQUFlQyxPQUFmLEdBQXlCckMsS0FBekIiLCJzb3VyY2VzQ29udGVudCI6WyIndXNlIHN0cmljdCc7XG5cbmNvbnN0IF8gPSByZXF1aXJlKCdsb2Rhc2gnKTtcbmNvbnN0IEhhc09uZSA9IHJlcXVpcmUoJy4vaGFzLW9uZScpO1xuY29uc3QgSGFzTWFueSA9IHJlcXVpcmUoJy4vaGFzLW1hbnknKTtcbmNvbnN0IEJlbG9uZ3NUb01hbnkgPSByZXF1aXJlKCcuL2JlbG9uZ3MtdG8tbWFueScpO1xuY29uc3QgQmVsb25nc1RvID0gcmVxdWlyZSgnLi9iZWxvbmdzLXRvJyk7XG5cbmZ1bmN0aW9uIGlzTW9kZWwobW9kZWwsIHNlcXVlbGl6ZSkge1xuICByZXR1cm4gbW9kZWxcbiAgICAmJiBtb2RlbC5wcm90b3R5cGVcbiAgICAmJiBtb2RlbC5wcm90b3R5cGUgaW5zdGFuY2VvZiBzZXF1ZWxpemUuU2VxdWVsaXplLk1vZGVsO1xufVxuXG5jb25zdCBNaXhpbiA9IHtcbiAgaGFzTWFueSh0YXJnZXQsIG9wdGlvbnMgPSB7fSkge1xuICAgIGlmICghaXNNb2RlbCh0YXJnZXQsIHRoaXMuc2VxdWVsaXplKSkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKGAke3RoaXMubmFtZX0uaGFzTWFueSBjYWxsZWQgd2l0aCBzb21ldGhpbmcgdGhhdCdzIG5vdCBhIHN1YmNsYXNzIG9mIFNlcXVlbGl6ZS5Nb2RlbGApO1xuICAgIH1cblxuICAgIGNvbnN0IHNvdXJjZSA9IHRoaXM7XG5cbiAgICAvLyBTaW5jZSB0aGlzIGlzIGEgbWl4aW4sIHdlJ2xsIG5lZWQgYSB1bmlxdWUgbGV0aWFibGUgbmFtZSBmb3IgaG9va3MgKHNpbmNlIE1vZGVsIHdpbGwgb3ZlcnJpZGUgb3VyIGhvb2tzIG9wdGlvbilcbiAgICBvcHRpb25zLmhvb2tzID0gb3B0aW9ucy5ob29rcyA9PT0gdW5kZWZpbmVkID8gZmFsc2UgOiBCb29sZWFuKG9wdGlvbnMuaG9va3MpO1xuICAgIG9wdGlvbnMudXNlSG9va3MgPSBvcHRpb25zLmhvb2tzO1xuXG4gICAgb3B0aW9ucyA9IE9iamVjdC5hc3NpZ24ob3B0aW9ucywgXy5vbWl0KHNvdXJjZS5vcHRpb25zLCBbJ2hvb2tzJ10pKTtcblxuICAgIGlmIChvcHRpb25zLnVzZUhvb2tzKSB7XG4gICAgICB0aGlzLnJ1bkhvb2tzKCdiZWZvcmVBc3NvY2lhdGUnLCB7IHNvdXJjZSwgdGFyZ2V0LCB0eXBlOiBIYXNNYW55IH0sIG9wdGlvbnMpO1xuICAgIH1cblxuICAgIC8vIHRoZSBpZCBpcyBpbiB0aGUgZm9yZWlnbiB0YWJsZSBvciBpbiBhIGNvbm5lY3RpbmcgdGFibGVcbiAgICBjb25zdCBhc3NvY2lhdGlvbiA9IG5ldyBIYXNNYW55KHNvdXJjZSwgdGFyZ2V0LCBvcHRpb25zKTtcbiAgICBzb3VyY2UuYXNzb2NpYXRpb25zW2Fzc29jaWF0aW9uLmFzc29jaWF0aW9uQWNjZXNzb3JdID0gYXNzb2NpYXRpb247XG5cbiAgICBhc3NvY2lhdGlvbi5faW5qZWN0QXR0cmlidXRlcygpO1xuICAgIGFzc29jaWF0aW9uLm1peGluKHNvdXJjZS5wcm90b3R5cGUpO1xuXG4gICAgaWYgKG9wdGlvbnMudXNlSG9va3MpIHtcbiAgICAgIHRoaXMucnVuSG9va3MoJ2FmdGVyQXNzb2NpYXRlJywgeyBzb3VyY2UsIHRhcmdldCwgdHlwZTogSGFzTWFueSwgYXNzb2NpYXRpb24gfSwgb3B0aW9ucyk7XG4gICAgfVxuXG4gICAgcmV0dXJuIGFzc29jaWF0aW9uO1xuICB9LFxuXG4gIGJlbG9uZ3NUb01hbnkodGFyZ2V0LCBvcHRpb25zID0ge30pIHtcbiAgICBpZiAoIWlzTW9kZWwodGFyZ2V0LCB0aGlzLnNlcXVlbGl6ZSkpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihgJHt0aGlzLm5hbWV9LmJlbG9uZ3NUb01hbnkgY2FsbGVkIHdpdGggc29tZXRoaW5nIHRoYXQncyBub3QgYSBzdWJjbGFzcyBvZiBTZXF1ZWxpemUuTW9kZWxgKTtcbiAgICB9XG5cbiAgICBjb25zdCBzb3VyY2UgPSB0aGlzO1xuXG4gICAgLy8gU2luY2UgdGhpcyBpcyBhIG1peGluLCB3ZSdsbCBuZWVkIGEgdW5pcXVlIGxldGlhYmxlIG5hbWUgZm9yIGhvb2tzIChzaW5jZSBNb2RlbCB3aWxsIG92ZXJyaWRlIG91ciBob29rcyBvcHRpb24pXG4gICAgb3B0aW9ucy5ob29rcyA9IG9wdGlvbnMuaG9va3MgPT09IHVuZGVmaW5lZCA/IGZhbHNlIDogQm9vbGVhbihvcHRpb25zLmhvb2tzKTtcbiAgICBvcHRpb25zLnVzZUhvb2tzID0gb3B0aW9ucy5ob29rcztcbiAgICBvcHRpb25zLnRpbWVzdGFtcHMgPSBvcHRpb25zLnRpbWVzdGFtcHMgPT09IHVuZGVmaW5lZCA/IHRoaXMuc2VxdWVsaXplLm9wdGlvbnMudGltZXN0YW1wcyA6IG9wdGlvbnMudGltZXN0YW1wcztcbiAgICBvcHRpb25zID0gT2JqZWN0LmFzc2lnbihvcHRpb25zLCBfLm9taXQoc291cmNlLm9wdGlvbnMsIFsnaG9va3MnLCAndGltZXN0YW1wcycsICdzY29wZXMnLCAnZGVmYXVsdFNjb3BlJ10pKTtcblxuICAgIGlmIChvcHRpb25zLnVzZUhvb2tzKSB7XG4gICAgICB0aGlzLnJ1bkhvb2tzKCdiZWZvcmVBc3NvY2lhdGUnLCB7IHNvdXJjZSwgdGFyZ2V0LCB0eXBlOiBCZWxvbmdzVG9NYW55IH0sIG9wdGlvbnMpO1xuICAgIH1cbiAgICAvLyB0aGUgaWQgaXMgaW4gdGhlIGZvcmVpZ24gdGFibGUgb3IgaW4gYSBjb25uZWN0aW5nIHRhYmxlXG4gICAgY29uc3QgYXNzb2NpYXRpb24gPSBuZXcgQmVsb25nc1RvTWFueShzb3VyY2UsIHRhcmdldCwgb3B0aW9ucyk7XG4gICAgc291cmNlLmFzc29jaWF0aW9uc1thc3NvY2lhdGlvbi5hc3NvY2lhdGlvbkFjY2Vzc29yXSA9IGFzc29jaWF0aW9uO1xuXG4gICAgYXNzb2NpYXRpb24uX2luamVjdEF0dHJpYnV0ZXMoKTtcbiAgICBhc3NvY2lhdGlvbi5taXhpbihzb3VyY2UucHJvdG90eXBlKTtcblxuICAgIGlmIChvcHRpb25zLnVzZUhvb2tzKSB7XG4gICAgICB0aGlzLnJ1bkhvb2tzKCdhZnRlckFzc29jaWF0ZScsIHsgc291cmNlLCB0YXJnZXQsIHR5cGU6IEJlbG9uZ3NUb01hbnksIGFzc29jaWF0aW9uIH0sIG9wdGlvbnMpO1xuICAgIH1cblxuICAgIHJldHVybiBhc3NvY2lhdGlvbjtcbiAgfSxcblxuICBnZXRBc3NvY2lhdGlvbnModGFyZ2V0KSB7XG4gICAgcmV0dXJuIF8udmFsdWVzKHRoaXMuYXNzb2NpYXRpb25zKS5maWx0ZXIoYXNzb2NpYXRpb24gPT4gYXNzb2NpYXRpb24udGFyZ2V0Lm5hbWUgPT09IHRhcmdldC5uYW1lKTtcbiAgfSxcblxuICBnZXRBc3NvY2lhdGlvbkZvckFsaWFzKHRhcmdldCwgYWxpYXMpIHtcbiAgICAvLyBUd28gYXNzb2NpYXRpb25zIGNhbm5vdCBoYXZlIHRoZSBzYW1lIGFsaWFzLCBzbyB3ZSBjYW4gdXNlIGZpbmQgaW5zdGVhZCBvZiBmaWx0ZXJcbiAgICByZXR1cm4gdGhpcy5nZXRBc3NvY2lhdGlvbnModGFyZ2V0KS5maW5kKGFzc29jaWF0aW9uID0+IGFzc29jaWF0aW9uLnZlcmlmeUFzc29jaWF0aW9uQWxpYXMoYWxpYXMpKSB8fCBudWxsO1xuICB9XG59O1xuXG4vLyBUaGUgbG9naWMgZm9yIGhhc09uZSBhbmQgYmVsb25nc1RvIGlzIGV4YWN0bHkgdGhlIHNhbWVcbmZ1bmN0aW9uIHNpbmdsZUxpbmtlZChUeXBlKSB7XG4gIHJldHVybiBmdW5jdGlvbih0YXJnZXQsIG9wdGlvbnMgPSB7fSkge1xuICAgIC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBuby1pbnZhbGlkLXRoaXNcbiAgICBjb25zdCBzb3VyY2UgPSB0aGlzO1xuICAgIGlmICghaXNNb2RlbCh0YXJnZXQsIHNvdXJjZS5zZXF1ZWxpemUpKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoYCR7c291cmNlLm5hbWV9LiR7Xy5sb3dlckZpcnN0KFR5cGUubmFtZSl9IGNhbGxlZCB3aXRoIHNvbWV0aGluZyB0aGF0J3Mgbm90IGEgc3ViY2xhc3Mgb2YgU2VxdWVsaXplLk1vZGVsYCk7XG4gICAgfVxuXG5cbiAgICAvLyBTaW5jZSB0aGlzIGlzIGEgbWl4aW4sIHdlJ2xsIG5lZWQgYSB1bmlxdWUgbGV0aWFibGUgbmFtZSBmb3IgaG9va3MgKHNpbmNlIE1vZGVsIHdpbGwgb3ZlcnJpZGUgb3VyIGhvb2tzIG9wdGlvbilcbiAgICBvcHRpb25zLmhvb2tzID0gb3B0aW9ucy5ob29rcyA9PT0gdW5kZWZpbmVkID8gZmFsc2UgOiBCb29sZWFuKG9wdGlvbnMuaG9va3MpO1xuICAgIG9wdGlvbnMudXNlSG9va3MgPSBvcHRpb25zLmhvb2tzO1xuXG4gICAgaWYgKG9wdGlvbnMudXNlSG9va3MpIHtcbiAgICAgIHNvdXJjZS5ydW5Ib29rcygnYmVmb3JlQXNzb2NpYXRlJywgeyBzb3VyY2UsIHRhcmdldCwgdHlwZTogVHlwZSB9LCBvcHRpb25zKTtcbiAgICB9XG4gICAgLy8gdGhlIGlkIGlzIGluIHRoZSBmb3JlaWduIHRhYmxlXG4gICAgY29uc3QgYXNzb2NpYXRpb24gPSBuZXcgVHlwZShzb3VyY2UsIHRhcmdldCwgT2JqZWN0LmFzc2lnbihvcHRpb25zLCBzb3VyY2Uub3B0aW9ucykpO1xuICAgIHNvdXJjZS5hc3NvY2lhdGlvbnNbYXNzb2NpYXRpb24uYXNzb2NpYXRpb25BY2Nlc3Nvcl0gPSBhc3NvY2lhdGlvbjtcblxuICAgIGFzc29jaWF0aW9uLl9pbmplY3RBdHRyaWJ1dGVzKCk7XG4gICAgYXNzb2NpYXRpb24ubWl4aW4oc291cmNlLnByb3RvdHlwZSk7XG5cbiAgICBpZiAob3B0aW9ucy51c2VIb29rcykge1xuICAgICAgc291cmNlLnJ1bkhvb2tzKCdhZnRlckFzc29jaWF0ZScsIHsgc291cmNlLCB0YXJnZXQsIHR5cGU6IFR5cGUsIGFzc29jaWF0aW9uIH0sIG9wdGlvbnMpO1xuICAgIH1cblxuICAgIHJldHVybiBhc3NvY2lhdGlvbjtcbiAgfTtcbn1cblxuTWl4aW4uaGFzT25lID0gc2luZ2xlTGlua2VkKEhhc09uZSk7XG5NaXhpbi5iZWxvbmdzVG8gPSBzaW5nbGVMaW5rZWQoQmVsb25nc1RvKTtcblxubW9kdWxlLmV4cG9ydHMgPSBNaXhpbjtcbm1vZHVsZS5leHBvcnRzLk1peGluID0gTWl4aW47XG5tb2R1bGUuZXhwb3J0cy5kZWZhdWx0ID0gTWl4aW47XG4iXX0=