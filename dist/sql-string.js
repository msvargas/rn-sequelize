'use strict';

const dataTypes = require('./data-types');

const {
  logger
} = require('./utils/logger');

function arrayToList(array, timeZone, dialect, format) {
  return array.reduce((sql, val, i) => {
    if (i !== 0) {
      sql += ', ';
    }

    if (Array.isArray(val)) {
      sql += `(${arrayToList(val, timeZone, dialect, format)})`;
    } else {
      sql += escape(val, timeZone, dialect, format);
    }

    return sql;
  }, '');
}

exports.arrayToList = arrayToList;

function escape(val, timeZone, dialect, format) {
  let prependN = false;

  if (val === undefined || val === null) {
    return 'NULL';
  }

  switch (typeof val) {
    case 'boolean':
      // SQLite doesn't have true/false support. MySQL aliases true/false to 1/0
      // for us. Postgres actually has a boolean type with true/false literals,
      // but sequelize doesn't use it yet.
      if (dialect === 'sqlite' || dialect === 'mssql') {
        return +!!val;
      }

      return (!!val).toString();

    case 'number':
      return val.toString();

    case 'string':
      // In mssql, prepend N to all quoted vals which are originally a string (for
      // unicode compatibility)
      prependN = dialect === 'mssql';
      break;
  }

  if (val instanceof Date) {
    val = dataTypes[dialect].DATE.prototype.stringify(val, {
      timezone: timeZone
    });
  }

  if (Buffer.isBuffer(val)) {
    if (dataTypes[dialect].BLOB) {
      return dataTypes[dialect].BLOB.prototype.stringify(val);
    }

    return dataTypes.BLOB.prototype.stringify(val);
  }

  if (Array.isArray(val)) {
    const partialEscape = escVal => escape(escVal, timeZone, dialect, format);

    if (dialect === 'postgres' && !format) {
      return dataTypes.ARRAY.prototype.stringify(val, {
        escape: partialEscape
      });
    }

    return arrayToList(val, timeZone, dialect, format);
  }

  if (!val.replace) {
    throw new Error(`Invalid value ${logger.inspect(val)}`);
  }

  if (dialect === 'postgres' || dialect === 'sqlite' || dialect === 'mssql') {
    // http://www.postgresql.org/docs/8.2/static/sql-syntax-lexical.html#SQL-SYNTAX-STRINGS
    // http://stackoverflow.com/q/603572/130598
    val = val.replace(/'/g, "''");

    if (dialect === 'postgres') {
      // null character is not allowed in Postgres
      val = val.replace(/\0/g, '\\0');
    }
  } else {
    // eslint-disable-next-line no-control-regex
    val = val.replace(/[\0\n\r\b\t\\'"\x1a]/g, s => {
      switch (s) {
        case '\0':
          return '\\0';

        case '\n':
          return '\\n';

        case '\r':
          return '\\r';

        case '\b':
          return '\\b';

        case '\t':
          return '\\t';

        case '\x1a':
          return '\\Z';

        default:
          return `\\${s}`;
      }
    });
  }

  return `${(prependN ? "N'" : "'") + val}'`;
}

exports.escape = escape;

function format(sql, values, timeZone, dialect) {
  values = [].concat(values);

  if (typeof sql !== 'string') {
    throw new Error(`Invalid SQL string provided: ${sql}`);
  }

  return sql.replace(/\?/g, match => {
    if (!values.length) {
      return match;
    }

    return escape(values.shift(), timeZone, dialect, true);
  });
}

exports.format = format;

function formatNamedParameters(sql, values, timeZone, dialect) {
  return sql.replace(/:+(?!\d)(\w+)/g, (value, key) => {
    if ('postgres' === dialect && '::' === value.slice(0, 2)) {
      return value;
    }

    if (values[key] !== undefined) {
      return escape(values[key], timeZone, dialect, true);
    }

    throw new Error(`Named parameter "${value}" has no value in the given object.`);
  });
}

exports.formatNamedParameters = formatNamedParameters;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL2xpYi9zcWwtc3RyaW5nLmpzIl0sIm5hbWVzIjpbImRhdGFUeXBlcyIsInJlcXVpcmUiLCJsb2dnZXIiLCJhcnJheVRvTGlzdCIsImFycmF5IiwidGltZVpvbmUiLCJkaWFsZWN0IiwiZm9ybWF0IiwicmVkdWNlIiwic3FsIiwidmFsIiwiaSIsIkFycmF5IiwiaXNBcnJheSIsImVzY2FwZSIsImV4cG9ydHMiLCJwcmVwZW5kTiIsInVuZGVmaW5lZCIsInRvU3RyaW5nIiwiRGF0ZSIsIkRBVEUiLCJwcm90b3R5cGUiLCJzdHJpbmdpZnkiLCJ0aW1lem9uZSIsIkJ1ZmZlciIsImlzQnVmZmVyIiwiQkxPQiIsInBhcnRpYWxFc2NhcGUiLCJlc2NWYWwiLCJBUlJBWSIsInJlcGxhY2UiLCJFcnJvciIsImluc3BlY3QiLCJzIiwidmFsdWVzIiwiY29uY2F0IiwibWF0Y2giLCJsZW5ndGgiLCJzaGlmdCIsImZvcm1hdE5hbWVkUGFyYW1ldGVycyIsInZhbHVlIiwia2V5Iiwic2xpY2UiXSwibWFwcGluZ3MiOiJBQUFBOztBQUVBLE1BQU1BLFNBQVMsR0FBR0MsT0FBTyxDQUFDLGNBQUQsQ0FBekI7O0FBQ0EsTUFBTTtBQUFFQyxFQUFBQTtBQUFGLElBQWFELE9BQU8sQ0FBQyxnQkFBRCxDQUExQjs7QUFFQSxTQUFTRSxXQUFULENBQXFCQyxLQUFyQixFQUE0QkMsUUFBNUIsRUFBc0NDLE9BQXRDLEVBQStDQyxNQUEvQyxFQUF1RDtBQUNyRCxTQUFPSCxLQUFLLENBQUNJLE1BQU4sQ0FBYSxDQUFDQyxHQUFELEVBQU1DLEdBQU4sRUFBV0MsQ0FBWCxLQUFpQjtBQUNuQyxRQUFJQSxDQUFDLEtBQUssQ0FBVixFQUFhO0FBQ1hGLE1BQUFBLEdBQUcsSUFBSSxJQUFQO0FBQ0Q7O0FBQ0QsUUFBSUcsS0FBSyxDQUFDQyxPQUFOLENBQWNILEdBQWQsQ0FBSixFQUF3QjtBQUN0QkQsTUFBQUEsR0FBRyxJQUFLLElBQUdOLFdBQVcsQ0FBQ08sR0FBRCxFQUFNTCxRQUFO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bUJNLEtBQUssSUFBSTtBQUNqQyxRQUFJLENBQUNGLE1BQU0sQ0FBQ0csTUFBWixFQUFvQjtBQUNsQixhQUFPRCxLQUFQO0FBQ0Q7O0FBRUQsV0FBT3RCLE1BQU0sQ0FBQ29CLE1BQU0sQ0FBQ0ksS0FBUCxFQUFELEVBQWlCakMsUUFBakIsRUFBMkJDLE9BQTNCLEVBQW9DLElBQXBDLENBQWI7QUFDRCxHQU5NLENBQVA7QUFPRDs7QUFDRFMsT0FBTyxDQUFDUixNQUFSLEdBQWlCQSxNQUFqQjs7QUFFQSxTQUFTZ0MscUJBQVQsQ0FBK0I5QixHQUEvQixFQUFvQ3lCLE1BQXBDLEVBQTRDN0IsUUFBNUMsRUFBc0RDLE9BQXRELEVBQStEO0FBQzdELFNBQU9HLEdBQUcsQ0FBQ3FCLE9BQUosQ0FBWSxnQkFBWixFQUE4QixDQUFDVSxLQUFELEVBQVFDLEdBQVIsS0FBZ0I7QUFDbkQsUUFBSSxlQUFlbkMsT0FBZixJQUEwQixTQUFTa0MsS0FBSyxDQUFDRSxLQUFOLENBQVksQ0FBWixFQUFlLENBQWYsQ0FBdkMsRUFBMEQ7QUFDeEQsYUFBT0YsS0FBUDtBQUNEOztBQUVELFFBQUlOLE1BQU0sQ0FBQ08sR0FBRCxDQUFOLEtBQWdCeEIsU0FBcEIsRUFBK0I7QUFDN0IsYUFBT0gsTUFBTSxDQUFDb0IsTUFBTSxDQUFDTyxHQUFELENBQVAsRUFBY3BDLFFBQWQsRUFBd0JDLE9BQXhCLEVBQWlDLElBQWpDLENBQWI7QUFDRDs7QUFDRCxVQUFNLElBQUl5QixLQUFKLENBQVcsb0JBQW1CUyxLQUFNLHFDQUFwQyxDQUFOO0FBQ0QsR0FUTSxDQUFQO0FBVUQ7O0FBQ0R6QixPQUFPLENBQUN3QixxQkFBUixHQUFnQ0EscUJBQWhDIiwic291cmNlc0NvbnRlbnQiOlsiJ3VzZSBzdHJpY3QnO1xuXG5jb25zdCBkYXRhVHlwZXMgPSByZXF1aXJlKCcuL2RhdGEtdHlwZXMnKTtcbmNvbnN0IHsgbG9nZ2VyIH0gPSByZXF1aXJlKCcuL3V0aWxzL2xvZ2dlcicpO1xuXG5mdW5jdGlvbiBhcnJheVRvTGlzdChhcnJheSwgdGltZVpvbmUsIGRpYWxlY3QsIGZvcm1hdCkge1xuICByZXR1cm4gYXJyYXkucmVkdWNlKChzcWwsIHZhbCwgaSkgPT4ge1xuICAgIGlmIChpICE9PSAwKSB7XG4gICAgICBzcWwgKz0gJywgJztcbiAgICB9XG4gICAgaWYgKEFycmF5LmlzQXJyYXkodmFsKSkge1xuICAgICAgc3FsICs9IGAoJHthcnJheVRvTGlzdCh2YWwsIHRpbWVab25lLCBkaWFsZWN0LCBmb3JtYXQpfSlgO1xuICAgIH0gZWxzZSB7XG4gICAgICBzcWwgKz0gZXNjYXBlKHZhbCwgdGltZVpvbmUsIGRpYWxlY3QsIGZvcm1hdCk7XG4gICAgfVxuICAgIHJldHVybiBzcWw7XG4gIH0sICcnKTtcbn1cbmV4cG9ydHMuYXJyYXlUb0xpc3QgPSBhcnJheVRvTGlzdDtcblxuZnVuY3Rpb24gZXNjYXBlKHZhbCwgdGltZVpvbmUsIGRpYWxlY3QsIGZvcm1hdCkge1xuICBsZXQgcHJlcGVuZE4gPSBmYWxzZTtcbiAgaWYgKHZhbCA9PT0gdW5kZWZpbmVkIHx8IHZhbCA9PT0gbnVsbCkge1xuICAgIHJldHVybiAnTlVMTCc7XG4gIH1cbiAgc3dpdGNoICh0eXBlb2YgdmFsKSB7XG4gICAgY2FzZSAnYm9vbGVhbic6XG4gICAgLy8gU1FMaXRlIGRvZXNuJ3QgaGF2ZSB0cnVlL2ZhbHNlIHN1cHBvcnQuIE15U1FMIGFsaWFzZXMgdHJ1ZS9mYWxzZSB0byAxLzBcbiAgICAvLyBmb3IgdXMuIFBvc3RncmVzIGFjdHVhbGx5IGhhcyBhIGJvb2xlYW4gdHlwZSB3aXRoIHRydWUvZmFsc2UgbGl0ZXJhbHMsXG4gICAgLy8gYnV0IHNlcXVlbGl6ZSBkb2Vzbid0IHVzZSBpdCB5ZXQuXG4gICAgICBpZiAoZGlhbGVjdCA9PT0gJ3NxbGl0ZScgfHwgZGlhbGVjdCA9PT0gJ21zc3FsJykge1xuICAgICAgICByZXR1cm4gKyEhdmFsO1xuICAgICAgfVxuICAgICAgcmV0dXJuICghIXZhbCkudG9TdHJpbmcoKTtcbiAgICBjYXNlICdudW1iZXInOlxuICAgICAgcmV0dXJuIHZhbC50b1N0cmluZygpO1xuICAgIGNhc2UgJ3N0cmluZyc6XG4gICAgLy8gSW4gbXNzcWwsIHByZXBlbmQgTiB0byBhbGwgcXVvdGVkIHZhbHMgd2hpY2ggYXJlIG9yaWdpbmFsbHkgYSBzdHJpbmcgKGZvclxuICAgIC8vIHVuaWNvZGUgY29tcGF0aWJpbGl0eSlcbiAgICAgIHByZXBlbmROID0gZGlhbGVjdCA9PT0gJ21zc3FsJztcbiAgICAgIGJyZWFrO1xuICB9XG5cbiAgaWYgKHZhbCBpbnN0YW5jZW9mIERhdGUpIHtcbiAgICB2YWwgPSBkYXRhVHlwZXNbZGlhbGVjdF0uREFURS5wcm90b3R5cGUuc3RyaW5naWZ5KHZhbCwgeyB0aW1lem9uZTogdGltZVpvbmUgfSk7XG4gIH1cblxuICBpZiAoQnVmZmVyLmlzQnVmZmVyKHZhbCkpIHtcbiAgICBpZiAoZGF0YVR5cGVzW2RpYWxlY3RdLkJMT0IpIHtcbiAgICAgIHJldHVybiBkYXRhVHlwZXNbZGlhbGVjdF0uQkxPQi5wcm90b3R5cGUuc3RyaW5naWZ5KHZhbCk7XG4gICAgfVxuXG4gICAgcmV0dXJuIGRhdGFUeXBlcy5CTE9CLnByb3RvdHlwZS5zdHJpbmdpZnkodmFsKTtcbiAgfVxuXG4gIGlmIChBcnJheS5pc0FycmF5KHZhbCkpIHtcbiAgICBjb25zdCBwYXJ0aWFsRXNjYXBlID0gZXNjVmFsID0+IGVzY2FwZShlc2NWYWwsIHRpbWVab25lLCBkaWFsZWN0LCBmb3JtYXQpO1xuICAgIGlmIChkaWFsZWN0ID09PSAncG9zdGdyZXMnICYmICFmb3JtYXQpIHtcbiAgICAgIHJldHVybiBkYXRhVHlwZXMuQVJSQVkucHJvdG90eXBlLnN0cmluZ2lmeSh2YWwsIHsgZXNjYXBlOiBwYXJ0aWFsRXNjYXBlIH0pO1xuICAgIH1cbiAgICByZXR1cm4gYXJyYXlUb0xpc3QodmFsLCB0aW1lWm9uZSwgZGlhbGVjdCwgZm9ybWF0KTtcbiAgfVxuXG4gIGlmICghdmFsLnJlcGxhY2UpIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoYEludmFsaWQgdmFsdWUgJHtsb2dnZXIuaW5zcGVjdCh2YWwpfWApO1xuICB9XG5cbiAgaWYgKGRpYWxlY3QgPT09ICdwb3N0Z3JlcycgfHwgZGlhbGVjdCA9PT0gJ3NxbGl0ZScgfHwgZGlhbGVjdCA9PT0gJ21zc3FsJykge1xuICAgIC8vIGh0dHA6Ly93d3cucG9zdGdyZXNxbC5vcmcvZG9jcy84LjIvc3RhdGljL3NxbC1zeW50YXgtbGV4aWNhbC5odG1sI1NRTC1TWU5UQVgtU1RSSU5HU1xuICAgIC8vIGh0dHA6Ly9zdGFja292ZXJmbG93LmNvbS9xLzYwMzU3Mi8xMzA1OThcbiAgICB2YWwgPSB2YWwucmVwbGFjZSgvJy9nLCBcIicnXCIpO1xuXG4gICAgaWYgKGRpYWxlY3QgPT09ICdwb3N0Z3JlcycpIHtcbiAgICAgIC8vIG51bGwgY2hhcmFjdGVyIGlzIG5vdCBhbGxvd2VkIGluIFBvc3RncmVzXG4gICAgICB2YWwgPSB2YWwucmVwbGFjZSgvXFwwL2csICdcXFxcMCcpO1xuICAgIH1cbiAgfSBlbHNlIHtcbiAgICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgbm8tY29udHJvbC1yZWdleFxuICAgIHZhbCA9IHZhbC5yZXBsYWNlKC9bXFwwXFxuXFxyXFxiXFx0XFxcXCdcIlxceDFhXS9nLCBzID0+IHtcbiAgICAgIHN3aXRjaCAocykge1xuICAgICAgICBjYXNlICdcXDAnOiByZXR1cm4gJ1xcXFwwJztcbiAgICAgICAgY2FzZSAnXFxuJzogcmV0dXJuICdcXFxcbic7XG4gICAgICAgIGNhc2UgJ1xccic6IHJldHVybiAnXFxcXHInO1xuICAgICAgICBjYXNlICdcXGInOiByZXR1cm4gJ1xcXFxiJztcbiAgICAgICAgY2FzZSAnXFx0JzogcmV0dXJuICdcXFxcdCc7XG4gICAgICAgIGNhc2UgJ1xceDFhJzogcmV0dXJuICdcXFxcWic7XG4gICAgICAgIGRlZmF1bHQ6IHJldHVybiBgXFxcXCR7c31gO1xuICAgICAgfVxuICAgIH0pO1xuICB9XG4gIHJldHVybiBgJHsocHJlcGVuZE4gPyBcIk4nXCIgOiBcIidcIikgKyB2YWx9J2A7XG59XG5leHBvcnRzLmVzY2FwZSA9IGVzY2FwZTtcblxuZnVuY3Rpb24gZm9ybWF0KHNxbCwgdmFsdWVzLCB0aW1lWm9uZSwgZGlhbGVjdCkge1xuICB2YWx1ZXMgPSBbXS5jb25jYXQodmFsdWVzKTtcblxuICBpZiAodHlwZW9mIHNxbCAhPT0gJ3N0cmluZycpIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoYEludmFsaWQgU1FMIHN0cmluZyBwcm92aWRlZDogJHtzcWx9YCk7XG4gIH1cblxuICByZXR1cm4gc3FsLnJlcGxhY2UoL1xcPy9nLCBtYXRjaCA9PiB7XG4gICAgaWYgKCF2YWx1ZXMubGVuZ3RoKSB7XG4gICAgICByZXR1cm4gbWF0Y2g7XG4gICAgfVxuXG4gICAgcmV0dXJuIGVzY2FwZSh2YWx1ZXMuc2hpZnQoKSwgdGltZVpvbmUsIGRpYWxlY3QsIHRydWUpO1xuICB9KTtcbn1cbmV4cG9ydHMuZm9ybWF0ID0gZm9ybWF0O1xuXG5mdW5jdGlvbiBmb3JtYXROYW1lZFBhcmFtZXRlcnMoc3FsLCB2YWx1ZXMsIHRpbWVab25lLCBkaWFsZWN0KSB7XG4gIHJldHVybiBzcWwucmVwbGFjZSgvOisoPyFcXGQpKFxcdyspL2csICh2YWx1ZSwga2V5KSA9PiB7XG4gICAgaWYgKCdwb3N0Z3JlcycgPT09IGRpYWxlY3QgJiYgJzo6JyA9PT0gdmFsdWUuc2xpY2UoMCwgMikpIHtcbiAgICAgIHJldHVybiB2YWx1ZTtcbiAgICB9XG5cbiAgICBpZiAodmFsdWVzW2tleV0gIT09IHVuZGVmaW5lZCkge1xuICAgICAgcmV0dXJuIGVzY2FwZSh2YWx1ZXNba2V5XSwgdGltZVpvbmUsIGRpYWxlY3QsIHRydWUpO1xuICAgIH1cbiAgICB0aHJvdyBuZXcgRXJyb3IoYE5hbWVkIHBhcmFtZXRlciBcIiR7dmFsdWV9XCIgaGFzIG5vIHZhbHVlIGluIHRoZSBnaXZlbiBvYmplY3QuYCk7XG4gIH0pO1xufVxuZXhwb3J0cy5mb3JtYXROYW1lZFBhcmFtZXRlcnMgPSBmb3JtYXROYW1lZFBhcmFtZXRlcnM7XG4iXX0=